<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Hand Controlled WebAR</title>
    
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://unpkg.com/aframe-chromakey-material/dist/aframe-chromakey-material.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  </head>
  
  <body style="margin: 0; overflow: hidden;">
    <div id="overlay" style="position:fixed; z-index:1000; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; font-family:sans-serif; text-align:center; padding:20px;">
      <h2>Step 1: Click to Start</h2>
      <button id="start-btn" style="padding:20px 40px; font-size:20px; border-radius:50px; border:none; background:#28a745; color:white; cursor:pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">ENTER AR</button>
      <p style="margin-top:20px; opacity:0.7;">Step 2: Point camera at your target image</p>
    </div>

    <a-scene mindar-image="imageTargetSrc: ./target.mind; autoStart: false;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      <a-assets>
        <video id="vid" src="video.mp4" loop="true" muted playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="ar-target" mindar-image-target="targetIndex: 0">
        <a-video id="ar-video" src="#vid" width="1" height="0.6" 
                 material="shader: chromakey; color: 0.1 0.9 0.2" 
                 position="0 0 0">
        </a-video>
      </a-entity>
    </a-scene>

    <script>
      const sceneEl = document.querySelector('a-scene');
      const startBtn = document.getElementById('start-btn');
      const video = document.getElementById('vid');
      const arVideo = document.querySelector('#ar-video');

      // 1. User Interaction to start everything
      startBtn.addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'none';
        
        // Start MindAR manually
        sceneEl.systems["mindar-image-system"].start();
        
        // Start Hand tracking only AFTER MindAR is ready
        sceneEl.addEventListener("arReady", () => {
          console.log("AR Ready! Starting Hand Tracking...");
          initMediaPipe();
        });
      });

      function initMediaPipe() {
        const hands = new Hands({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
          maxNumHands: 1,
          modelComplexity: 1,
          minDetectionConfidence: 0.6,
          minTrackingConfidence: 0.6
        });

        hands.onResults((results) => {
          if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];

            // TRACKING: Move video with Index Finger (Landmark 8)
            const x = (landmarks[8].x - 0.5) * 2;
            const y = (0.5 - landmarks[8].y) * 2;
            arVideo.setAttribute('position', `${x} ${y} 0`);

            // GESTURE: Open Palm to Play, Fist to Pause
            const isOpen = landmarks[12].y < landmarks[9].y;
            if (isOpen) {
              video.play();
              arVideo.setAttribute('scale', '1.1 1.1 1.1');
            } else {
              video.pause();
              arVideo.setAttribute('scale', '0.8 0.8 0.8');
            }
          }
        });

        // Use the existing MindAR camera feed
        const mindVideo = document.querySelector('video');
        if (mindVideo) {
          const camera = new Camera(mindVideo, {
            onFrame: async () => { await hands.send({image: mindVideo}); },
            width: 640, height: 480
          });
          camera.start().catch(err => console.error("MediaPipe Camera Error:", err));
        }
      }
    </script>
  </body>
</html>




